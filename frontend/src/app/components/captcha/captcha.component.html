<div class="captcha-container">
  <div class="captcha-header">
    <h1>Security Verification</h1>
    <p>Complete all three levels to verify you're human</p>
    
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <div class="progress-labels">
        <span class="level-indicator" 
              [class.completed]="results[1] === true"
              [class.current]="currentLevel === 1"
              [class.failed]="results[1] === false">1</span>
        <span class="level-indicator" 
              [class.completed]="results[2] === true"
              [class.current]="currentLevel === 2"
              [class.failed]="results[2] === false">2</span>
        <span class="level-indicator" 
              [class.completed]="results[3] === true"
              [class.current]="currentLevel === 3"
              [class.failed]="results[3] === false">3</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading captcha...</p>
  </div>

  <!-- Success State -->
  <div *ngIf="showSuccess" class="success-container">
    <div class="success-icon">✓</div>
    <h2>Verification Complete!</h2>
    <p>You have successfully completed all security challenges.</p>
    <button class="btn btn-primary" (click)="restart()">Start New Challenge</button>
  </div>

  <!-- Challenge Content -->
  <div *ngIf="!isLoading && !showSuccess && captchaData" class="challenge-container">
    <div class="challenge-header">
      <h2>Level {{ currentLevel }} of 3</h2>
      <p class="challenge-question">{{ getCurrentChallenge()?.question }}</p>
    </div>

    <!-- Image Selection Challenge -->
    <div *ngIf="getCurrentChallenge()?.type === 'image-select'" class="image-challenge">
      <div class="image-grid">
        <div *ngFor="let image of getCurrentChallenge()?.images" 
             class="image-item"
             [class.selected]="isImageSelected(image.id)"
             (click)="onImageSelect(image.id)">
          <img [src]="'https://picsum.photos/200/150?random=' + image.id" 
               [alt]="'Challenge image ' + image.id"
               loading="lazy">
          <div class="image-overlay">
            <div class="checkmark" *ngIf="isImageSelected(image.id)">✓</div>
          </div>
        </div>
      </div>
      <p class="instruction">Click on the images that match the description above</p>
    </div>

    <!-- Text Input Challenge -->
    <div *ngIf="getCurrentChallenge()?.type === 'text'" class="text-challenge">
      <div class="input-group">
        <input type="text" 
               [(ngModel)]="answers[currentLevel]"
               placeholder="Enter your answer"
               class="text-input"
               [disabled]="isSubmitting">
      </div>
    </div>

    <!-- Math Challenge -->
    <div *ngIf="getCurrentChallenge()?.type === 'math'" class="math-challenge">
      <div class="input-group">
        <input type="number" 
               [(ngModel)]="answers[currentLevel]"
               placeholder="Enter the result"
               class="number-input"
               [disabled]="isSubmitting">
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
      <span class="error-icon">⚠</span>
      {{ errorMessage }}
    </div>

    <!-- Submit Button -->
    <div class="submit-container">
      <button class="btn btn-primary" 
              [disabled]="!canSubmit() || isSubmitting"
              (click)="submitAnswer()">
        <span *ngIf="isSubmitting" class="spinner-small"></span>
        {{ isSubmitting ? 'Verifying...' : 'Submit Answer' }}
      </button>
    </div>

    <!-- Result Indicator -->
    <div *ngIf="results[currentLevel] !== null" class="result-indicator">
      <div *ngIf="results[currentLevel]" class="result-success">
        <span class="result-icon">✓</span>
        Correct! Moving to next level...
      </div>
      <div *ngIf="results[currentLevel] === false" class="result-error">
        <span class="result-icon">✗</span>
        Incorrect answer. Please try again.
      </div>
    </div>
  </div>

  <!-- Restart Button -->
  <div *ngIf="!isLoading && !showSuccess" class="restart-container">
    <button class="btn btn-secondary" (click)="restart()">
      Start Over
    </button>
  </div>
</div>